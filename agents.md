# Agents Guide: bblocks-viewer Fork

This is a fork of [ogcincubator/bblocks-viewer](https://github.com/ogcincubator/bblocks-viewer) — a Vue 3 + Vuetify SPA that renders OGC Building Block registers. This fork adds a "Resolved (JSON)" button to the JSON Schema tab for viewing fully resolved schemas.

## What This Application Does

The viewer loads a `register.json` file (produced by the OGC Building Blocks postprocessor) and renders each building block with tabs for About, Examples, JSON Schema, OpenAPI, Ontology, Semantic Uplift, Validation, and Transforms. Users can browse building blocks, view schemas in multiple formats, and navigate cross-references between blocks.

## Architecture

```
┌─────────────────────────────────────────────────────────────────┐
│  config.service.js                                              │
│  - Reads register URL from VITE_BBLOCK_REGISTER env var,        │
│    ?register= query param, or window.bblocksRegister             │
└──────────────┬──────────────────────────────────────────────────┘
               │
               ▼
┌─────────────────────────────────────────────────────────────────┐
│  bblock.service.js                                              │
│  - _loadRegister(url): fetches register.json, populates         │
│    this.bblocks.all / this.bblocks.local                        │
│  - fetchBBlock(id): fetches json-full document, copies           │
│    COPY_PROPERTIES from register entry → returns full bblock     │
│  - fetchDocumentByUrl(bblock, url): fetches any URL as text     │
│  - COPY_PROPERTIES: whitelist of register-only properties        │
│    that persist through fetchBBlock()                            │
└──────────────┬──────────────────────────────────────────────────┘
               │
               ▼
┌─────────────────────────────────────────────────────────────────┐
│  views/BuildingBlock.vue → components/BuildingBlock.vue         │
│  - Calls fetchBBlock(id), stores result as this.bblock          │
│  - Renders tabbed UI, passes bblock to child components          │
└──────────────┬──────────────────────────────────────────────────┘
               │
               ▼
┌─────────────────────────────────────────────────────────────────┐
│  components/bblock/JsonSchemaViewer.vue                          │
│  - Receives bblock prop                                          │
│  - Button toggle: Source | Full (YAML) | Full (JSON) |           │
│    Resolved (JSON)                                               │
│  - Lazy-fetches schema content on mode switch                    │
│  - Displays in CodeViewer with clickable cross-references        │
└─────────────────────────────────────────────────────────────────┘
```

## Key Data Flow: COPY_PROPERTIES

When `fetchBBlock(id)` is called, it loads the full bblock data from a separate `json-full` URL (generated by the OGC postprocessor). This JSON file does NOT contain custom properties added to `register.json`. Only properties listed in `COPY_PROPERTIES` are copied from the register entry to the fetched bblock object:

```javascript
const COPY_PROPERTIES = ['local', 'register', 'importLevel', 'resolvedSchema']
```

**Any custom property added to `register.json` must also be added to `COPY_PROPERTIES`**, or it will be silently dropped when the full bblock is loaded.

## Fork Changes

### 1. "Resolved (JSON)" button (`JsonSchemaViewer.vue`)

Added a 4th button to the JSON Schema tab's toggle group that displays the fully resolved schema — all `$ref` inlined, `allOf` flattened, no `$defs` or external references. This is the schema used as the source of truth for JSON Forms rendering.

**Conditionally shown:** The button only appears when `bblock.resolvedSchema` is set (i.e., the register has a `resolvedSchema` URL for that bblock). Non-profile building blocks don't have resolved schemas.

**Implementation follows the same pattern as the existing buttons:**
- `resolvedJson` data state (`{ loading, contents, error }`) — alongside `sourceSchema` and `jsonAnnotated`
- `currentSchema` computed adds `case 'resolved-json'`
- `currentSchemaLoading` computed adds the loading check
- `mode` watcher adds an `else if (v === 'resolved-json')` branch that calls `bblockService.fetchDocumentByUrl()` on first switch, with JSON stringification if the response is an object
- Error alert shown when `resolvedJson.error` is set
- URL display block shown when mode is `resolved-json`

### 2. COPY_PROPERTIES addition (`bblock.service.js`)

Added `'resolvedSchema'` to the `COPY_PROPERTIES` array so the URL persists from the register entry through `fetchBBlock()`.

## How resolvedSchema URLs Get Into register.json

The `resolvedSchema` URLs are injected by `augment_register.py` in the [OCGbuildingBlockTest](https://github.com/smrgeoinfo/OCGbuildingBlockTest) repository. That script runs after the OGC postprocessor generates `register.json` and adds URLs like:

```
https://smrgeoinfo.github.io/OCGbuildingBlockTest/_sources/profiles/adaProduct/resolvedSchema.json
```

for each profile bblock that has a `resolvedSchema.json` file in `_sources/profiles/{name}/`.

## Project Structure

```
src/
├── views/
│   ├── BuildingBlock.vue          # Route view, delegates to component
│   ├── BuildingBlockList.vue      # List/search view
│   ├── Home.vue                   # Landing page
│   └── NotFound.vue
├── components/
│   ├── BuildingBlock.vue          # Main bblock detail component (tabs)
│   ├── bblock/
│   │   ├── JsonSchemaViewer.vue   # ★ Schema tab (Source/Full/Resolved buttons)
│   │   ├── ExampleViewer.vue      # Examples tab
│   │   ├── JsonLdContextViewer.vue
│   │   ├── OntologyViewer.vue
│   │   ├── OpenApiDocumentViewer.vue
│   │   ├── SemanticUplift.vue
│   │   ├── ValidationBanner.vue
│   │   └── ...
│   ├── CodeViewer.vue             # Syntax-highlighted code display
│   ├── CopyTextField.vue          # URL display with copy button
│   └── ...
├── services/
│   ├── bblock.service.js          # ★ Register loading, bblock fetching, COPY_PROPERTIES
│   ├── config.service.js          # Reads VITE_BBLOCK_REGISTER env var
│   ├── http.service.js            # Axios client
│   └── ontology.service.js
└── ...
```

★ = files modified in this fork

## Local Development

```bash
# Install dependencies
npm install --legacy-peer-deps

# Start dev server with a local register
VITE_BBLOCK_REGISTER=http://localhost:8090/build/register.json npm run dev

# The register must be served with CORS headers — use cors_server.py from
# OCGbuildingBlockTest (run from the repo root so both build/ and _sources/ are accessible):
python tools/cors_server.py 8090 /path/to/OCGbuildingBlockTest
```

The `VITE_BBLOCK_REGISTER` env var can also be set via `?register=` query parameter in the browser URL.
